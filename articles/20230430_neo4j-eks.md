---
title: "EKSæ§‹æˆã‚’æŠŠæ¡ã™ã‚‹ãŸã‚ã«Neo4j Desktopã‚’ä½¿ã†"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["neo4j", "k8s", "eks"]
published: true
published_at: 2023-05-01 09:00
---

k8sã¯é‹ç”¨ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå¤šãã€ã‚¢ãƒ—ãƒªé–‹ç™ºã‚’ç¶šã‘ã¦ã„ãã†ã¡ã«å…¨ä½“åƒãŒæŠŠæ¡ã—ã¥ã‚‰ããªã‚Šãã†...ã¨ã„ã†å±æ©Ÿæ„Ÿã‹ã‚‰Neo4jã‚’ä½¿ã£ã¦k8sæ§‹æˆã®å¯è¦–åŒ–ã‚’è©¦ã—ã¾ã—ãŸã€‚
ã“ã®è¨˜äº‹ã§ã¯Neo4j Desktopã‚’ä½¿ã£ã¦Amazon EKSã‚’å¯è¦–åŒ–ã—ã¦ã„ã¾ã™ã€‚

## Neo4j Desktopã«ã¤ã„ã¦
[Download Neo4j Desktop](https://neo4j.com/download/)ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚
ä»¥å‰ã¯neo4jãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚µãƒ¼ãƒã‚’ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã—ã¦...ã¨è¨€ã†æ‰‹é †ãŒå¿…è¦ã§ã—ãŸãŒã€Neo4j Desktopã«ã‚ˆã£ã¦GUIã§ç°¡å˜ã«Neo4jã‚µãƒ¼ãƒã‚’èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

å€‹äººçš„ã«ã¯ãã®åˆ†ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ãŸã‚Š`neo4j.conf`ã‚„`apoc.conf`ã®ä¿å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¢ã—ãŸã‚Šã€æ„å¤–ã¨æ‰‹é–“å–ã‚Šã¾ã—ãŸã€‚
ä»Šå›ã¯åå‰ç©ºé–“ãƒ»ãƒãƒƒãƒ‰ãƒ»ã‚³ãƒ³ãƒ†ãƒŠã®æ§‹æˆæƒ…å ±ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã‚’æº–å‚™ã—ã¦ãŠãã¾ã™ã€‚

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æœ‰åŠ¹åŒ–
https://neo4j.com/docs/desktop-manual/current/operations/install-plugin/
`APOC`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã¾ã™ã€‚

### ã‚³ãƒ³ãƒ•ã‚£ã‚°ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
[Default file locations](https://neo4j.com/docs/operations-manual/current/configuration/file-locations/)ã‚’å‚è€ƒã«GUIã‹ã‚‰ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ãã¨ç°¡å˜ã«è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã™ã€‚

- `kubectl`ã§å–å¾—ã—ãŸEKSæ§‹æˆæƒ…å ±
    - å–å¾—ã‚³ãƒãƒ³ãƒ‰ã¯`kubectl get namespace -o=json`ã¨`kubectl get pod -A -o=json`ã€ã“ã‚Œã‚‰jsonãƒ•ã‚¡ã‚¤ãƒ«ã¯`Import`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¾ã™
        ```bash
        $ ll import
        total 1584
        -rw-r--r--@ 1 ts  staff    4203  4 29 14:01 kubectl_namespace.json
        -rw-r--r--@ 1 ts  staff  801081  4 29 14:02 kubectl_pods.json
        ```

- `apoc.load.json`æœ‰åŠ¹åŒ–
    - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç„¡åŠ¹ã®ãŸã‚`apoc.conf`ã‚’æ–°è¦ä½œæˆã—ã¦`Configuration`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¾ã™
        ```
        $ cat conf/apoc.conf
        apoc.import.file.enabled=true
        ```

## EKSæ§‹æˆã®jsonãƒ‡ãƒ¼ã‚¿ã‚’Neo4jã«ãƒ­ãƒ¼ãƒ‰

```
call apoc.load.json("./kubectl_namespace.json")
yield value
with value
unwind value.items as item
merge (namespace:NameSpace {name: item.metadata.name, status: item.status.phase})

return namespace
;
```

é…åˆ—ã®å±•é–‹ã¯`UNWIND`ã‚’ä½¿ã„ã¤ã¤ã€`MERGE`ã§ãƒãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚
![](/images/neo4j_eks-pod.png)


```
call apoc.load.json("./kubectl_pods.json")
yield value
with value
unwind value.items as item
merge (pod:Pod {name: item.metadata.name, namespace: item.metadata.namespace})

with value
unwind value.items as item
match (pod:Pod {name: item.metadata.name})
set pod.application = item.metadata.labels.app

return pod
;
```

`MERGE`ã§ã¯nullã‚’è¨±å®¹ã—ãªã„ä»•æ§˜ã®ãŸã‚ã€å¾Œã‹ã‚‰`SET`ã§å±æ€§ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚
ref: https://community.neo4j.com/t/unwind-with-js-driver-yields-cannot-merge-node-using-null-property/15488
![](/images/neo4j_eks_namespace.png)


æœ€ä½é™ã®ãƒãƒ¼ãƒ‰ã‚’ä½œæˆã—ãŸã®ã§relationã‚’ä½œæˆã—ã¾ã™ã€‚
```
match (n:NameSpace)
match (p:Pod)
where p.namespace = n.name
merge (p)-[:IN]->(n)
;
```

ã“ã®æ™‚ç‚¹ã§ã‚°ãƒ©ãƒ•ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚åå‰ç©ºé–“ã”ã¨ã«ã©ã®ç¨‹åº¦ã®PodãŒå­˜åœ¨ã™ã‚‹ã‹ã‚ã‹ã‚Šã¾ã™ã€‚
![](/images/neo4j_eks-relations.png)

### Podå†…ã§èµ·å‹•ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒãƒ¼ãƒ‰è¿½åŠ 
Podã§ã¯è¤‡æ•°ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ãŒä¸€èˆ¬çš„ãªãŸã‚ã€Podå†…ã®å„ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒãƒ¼ãƒ‰ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚

```
call apoc.load.json("./kubectl_pods.json")
yield value
with value
unwind value.items as item
unwind item.spec.containers as c
match (pod:Pod)
where pod.name = item.metadata.name
merge (con:Container {name: c.name, image: c.image})<-[:RUN]-(pod)

return con, pod
;
```

å†å¸°çš„ãªé…åˆ—ã®å±•é–‹ã‚’ã—ãŸã„å ´åˆã¯`UNWIND`ã‚’è¤‡æ•°å®£è¨€ã™ã‚Œã°æ¸ˆã¿ã€ä¸Šè¨˜ã§ã¯ã‚³ãƒ³ãƒ†ãƒŠã®é…åˆ—ã‚’å±•é–‹ã—ã¤ã¤æ—¢å­˜ã®Podåã¨ä¸€è‡´ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠãƒãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚


### ä½œæˆæ¸ˆã¿ã®ãƒãƒ¼ãƒ‰ã«ä»»æ„ã®å±æ€§ã‚’è¿½åŠ 
æ¤œç´¢ç”¨é€”ã‚’è€ƒãˆã¦ã€Podã«`kind`å±æ€§ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã®å€¤ã¯Podã®ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ç¨®åˆ¥ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚
ref: [ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®æ¦‚è¦](https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-workloads-overview?hl=ja)

```
call apoc.load.json("./kubectl_pods.json")
yield value
with value
unwind value.items as item
match (pod:Pod {name: item.metadata.name})
set pod.kind = item.metadata.ownerReferences[0].kind
;
```


## ã‚¯ã‚¨ãƒªæ¤œç´¢ã„ã‚ã„ã‚

### å…¨ãƒãƒ¼ãƒ‰å–å¾—
```
match (n:NameSpace)--(p:Pod)--(c:Container)
return n,p,c
;
```
![](/images/neo4j_eks-all.png)


### ReplicaSetã®Podå…¨ã¦
```
match (n:NameSpace)--(p:Pod)--(c:Container)
where p.kind = "ReplicaSet"
return n,p,c
```
![](/images/neo4j_eks-replicaset.png)

### ECRã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã„ãªã„ã‚³ãƒ³ãƒ†ãƒŠ
```
match (n:NameSpace)--(p:Pod)--(c:Container)
where not c.image =~ '.*\.ecr\..*'
return n,p,c
;
```
![](/images/neo4j_eks-notEcr.png)


## ä»Šå¾Œã®èª²é¡Œ
ã¾ãšã¯å†…éƒ¨ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ä½¿ã„å§‹ã‚ã‚‹å¯èƒ½æ€§ã‚‚æœ‰æœ›ã§ã™ãŒã€Neo4j Desktopã¯å€‹äººåˆ©ç”¨ã«é™å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒãƒ¼ãƒ ã§ä½¿ã„ãŸã„å ´é¢ã§ã¯ã‚°ãƒ©ãƒ•DBã‚’æ§‹ç¯‰ã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™ã€‚
ã¾ãŸã€Cypherã‚¯ã‚¨ãƒªã‚’ãƒãƒ¼ãƒ å†…ã§å…±æœ‰ã™ã‚‹æ–¹æ³•ã‚‚æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã‚¯ã‚¨ãƒªã‚„ãƒ‡ãƒ¼ã‚¿ã‚’GitHubç®¡ç†ã—ãŸã„å ´åˆã¯Webã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ãªã‚Šãã†ã§ã™ã€‚

ç¾æ®µéšã§ã¯JupyterNotebookã§Cypherã‚¯ã‚¨ãƒªç’°å¢ƒã‚’ã¤ãã£ã¦ã€ãƒãƒ¼ãƒ é–‹ç™ºã«å¯¾å¿œã§ããªã„ã‹æ¤œè¨¼ã—ã¦ã¿ãŸã„ã¨ã“ã‚ã§ã™ã€‚


## å‚è€ƒãƒšãƒ¼ã‚¸
[Cypher Manual / Clauses](https://neo4j.com/docs/cypher-manual/current/clauses/)
[neo4j-graph-examples](https://github.com/neo4j-graph-examples)
